<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chatbot Main Activity</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body class="main-body" data-username="{{ username if username }}">

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Threads</h2>
            <button type="button" class="new-chat-float-btn" id="newChatFloatBtn" title="Start New Chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>

        <div class="thread-list">
            {# Thread items will be listed here. This area will scroll. #}
            {% for thread in threads %}
            <div class="thread-item-row {{ 'active' if thread.id == active_thread_id }}">
                <a href="{{ url_for('main_activity', thread_id=thread.id) }}" class="thread-item-link">
                    <div class="thread-title">{{ thread.title }}</div>
                    <div class="thread-date">{{ thread.created_at.strftime('%b %d') }}</div>
                </a>
                <button class="icon-btn thread-delete-btn" data-thread-id="{{ thread.id }}" title="Delete thread">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m5 0V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2">
                        </path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
            </div>
            {% endfor %}
        </div>

        <div class="sidebar-footer">
            <a href="{{ url_for('logout') }}" class="logout-sidebar-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="feather feather-log-out">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </a>
        </div>
    </div>

    <div class="chat-container">

        <div class="chat-header">
            <h1>Welcome {{ username if username else 'Guest' }}</h1>
        </div>

        <div class="chat-history" id="chatHistory">

            {% if history %}
            {% for message in history %}
            {% set role_class = 'user' if message.role == 'user' else 'ai' %}


            {% set avatar_char = username[0] | upper if message.role == 'user' and username else 'Y' if message.role ==
            'user' else 'ðŸ¤–' %}

            <div class="message {{ role_class }}-message">

                <div class="avatar {{ role_class }}-avatar">{{ avatar_char }}</div>

                <div class="message-content-wrapper">

                    {# START MODIFICATION: Conditionally apply message-bubble #}
                    {% if message.role == 'user' %}
                    <div class="message-bubble">

                        {% if message.image %}
                        <div class="image-bubble-wrapper">
                            <img src="data:{{ message.image.mime_type }};base64,{{ message.image.base64_data }}"
                                class="uploaded-img-preview-bubble" alt="User uploaded image"
                                data-full-src="data:{{ message.image.mime_type }};base64,{{ message.image.base64_data }}">
                        </div>
                        {% endif %}

                        <div class="text-content">
                            {% if message.content %}
                            {{ message.content | markdown }}
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    {# AI Message - No Bubble #}
                    {% if message.image %}
                    <div class="image-bubble-wrapper">
                        <img src="data:{{ message.image.mime_type }};base64,{{ message.image.base64_data }}"
                            class="uploaded-img-preview-bubble" alt="User uploaded image"
                            data-full-src="data:{{ message.image.mime_type }};base64,{{ message.image.base64_data }}">
                    </div>
                    {% endif %}

                    <div class="diagnosis-card">
                        <div class="text-content">
                            {% if message.content %}
                            {{ message.content | markdown }}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {# END MODIFICATION #}

                    {% if message.role == 'ai' %}
                    <button class="icon-btn copy-message-btn" title="Copy Message"
                        data-raw-content="{{ message.content }}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <div id="typingIndicator" class="message ai-message typing-indicator-wrapper" style="display: none;">

                <div class="avatar ai-avatar">ðŸ¤–</div>
                <div class="message-content-wrapper">
                    <div class="message-bubble">
                        <span class="dot-flashing"></span>
                    </div>
                </div>
            </div>

            <div id="scrollToBottomAnchor"></div>
        </div>


        <div class="input-area-container">

            <div id="filePreview" class="file-preview-bar" style="display: none;">
                <img id="imageThumbnail" class="file-preview-thumbnail" src="" alt="Image Preview">
                <span id="fileNameDisplay" class="file-preview-name"></span>
                <button type="button" id="removeFileBtn" class="icon-btn remove-file-btn" title="Remove File">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <form id="chatForm" enctype="multipart/form-data">
                <input type="hidden" name="thread_id" value="{{ active_thread_id }}">
                <div class="input-group">

                    <button type="button" id="addFileBtn" class="icon-btn attach-btn" title="Attach File (Image)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="feather feather-paperclip">
                            <path
                                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                            </path>
                        </svg>
                    </button>
                    <input type="file" id="imageUpload" name="image" accept="image/*" style="display:none;">

                    <textarea id="queryInput" name="query"
                        placeholder="Message {{ username if username else 'User' }}..." rows="1" required></textarea>

                    <button type="submit" class="icon-btn send-btn" title="Send Message">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                            class="feather feather-send">
                            <line x1="22" y1="2" x2="11" y2="13" />
                            <polygon points="22 2 15 22 11 13 2 9 22 2" />
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="imageModal" class="image-modal">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="fullImage">
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>